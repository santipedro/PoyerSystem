<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geração de Lote - Poyer</title>
    <link rel="icon" type="image/png" href="img/Vector(2).png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        :root {
            --sidebar-bg: #1a1d2e;
            --sidebar-active: #393c53;
            --main-bg: #ffffff;
            --content-bg: #f8f9fe;
            --border-color: #e9ecef;
            --text-primary: #1a1d2e;
            --text-secondary: #6c757d;
            --text-light: #e0e0e0;
            --color-green: #19b16a;
            --color-green-light: #e4f8ee;
            --color-orange: #f08532;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body,
        html {
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--sidebar-bg);
            overflow: hidden;
        }

        .page-container {
            display: flex;
            width: 100%;
            height: 100vh;
        }

        .sidebar {
            flex-basis: 280px;
            flex-shrink: 0;
            background-color: var(--sidebar-bg);
            color: var(--text-light);
            padding: 24px;
            display: flex;
            flex-direction: column;
        }

        .sidebar-search {
            display: flex;
            align-items: center;
            background-color: var(--sidebar-active);
            border-radius: 8px;
            padding: 10px 14px;
            margin-bottom: 30px;
        }

        .sidebar-search i {
            margin-right: 12px;
            color: var(--text-secondary);
        }

        .sidebar-search input {
            flex: 1;
            background: none;
            border: none;
            outline: none;
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .sidebar-search input::placeholder {
            color: var(--text-secondary);
        }

        .sidebar-nav {
            list-style: none;
            margin-bottom: 20px;
        }

        .sidebar-nav li {
            margin-bottom: 8px;
        }

        .sidebar-nav a {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            text-decoration: none;
            color: var(--text-secondary);
            border-radius: 8px;
            transition: background-color 0.3s, color 0.3s;
        }

        .sidebar-nav a i {
            width: 20px;
            margin-right: 16px;
            font-size: 1.1rem;
            text-align: center;
        }

        .sidebar-nav a span {
            font-weight: 500;
        }

        .sidebar-nav a:hover,
        .sidebar-nav li.active a {
            background-color: var(--sidebar-active);
            color: #ffffff;
        }

        .sidebar-footer {
            margin-top: auto;
        }

        .user-profile {
            display: flex;
            align-items: center;
            background-color: var(--sidebar-active);
            border-radius: 10px;
            padding: 12px;
            margin-top: 20px;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 12px;
            object-fit: cover;
        }

        .user-info {
            flex: 1;
        }

        .user-info .user-name {
            display: block;
            font-weight: 600;
            color: #ffffff;
            font-size: 0.9rem;
        }

        .user-info .user-email {
            display: block;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .user-profile>i {
            color: var(--text-secondary);
            cursor: pointer;
        }

        .main-content {
            flex: 1;
            background-color: var(--content-bg);
            border-top-left-radius: 30px;
            overflow-y: auto;
            padding: 30px 40px;
        }

        .main-header {
            margin-bottom: 30px;
        }

        .main-header h1 {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .page-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .filters {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-tag {
            background-color: var(--color-green-light);
            color: var(--color-green);
            font-size: 0.9rem;
            font-weight: 500;
            padding: 6px 10px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .filter-tag i {
            cursor: pointer;
            font-size: 0.8rem;
        }

        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.3s;
        }

        .btn-filter {
            background-color: var(--main-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 8px 12px;
        }

        .btn-filter:hover {
            background-color: #f1f3f5;
        }

        .btn-xml {
            background-color: var(--color-orange);
            color: #ffffff;
        }

        .btn-xml:hover {
            background-color: #d87028;
        }

        .page-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .total-selected {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .total-selected span {
            color: var(--text-primary);
            font-weight: 600;
        }

        .action-search {
            display: flex;
            align-items: center;
            background-color: #ffffff;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px 12px;
        }

        .action-search i {
            color: var(--text-secondary);
            margin-right: 8px;
        }

        .action-search input {
            border: none;
            outline: none;
            font-size: 0.9rem;
        }

        .action-search input::placeholder {
            color: #aaa;
        }

        .billing-list-container {
            background-color: var(--main-bg);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.04);
            overflow: hidden;
        }

        .list-item {
            display: grid;
            grid-template-columns: 50px 2fr 1.5fr 2fr 1.5fr 1fr;
            align-items: center;
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-color);
        }

        .billing-list-container .list-item:last-child {
            border-bottom: none;
        }

        .list-header {
            color: var(--text-secondary);
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background-color: #fdfdfd;
        }

        .list-header i.fa-sort-down {
            font-size: 0.9rem;
            margin-left: 4px;
        }

        .list-row {
            font-size: 0.9rem;
            color: var(--text-primary);
            transition: background-color 0.2s;
        }

        .list-row:hover {
            background-color: #f8f9fa;
        }

        .col-check i {
            font-size: 1.2rem;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .col-check i.fa-square-check {
            color: var(--color-green);
        }

        .col-convenio {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
        }

        .logo-op {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: contain;
            border: 1px solid var(--border-color);
        }

        .col-valor {
            font-weight: 600;
        }
    </style>
</head>

<body>

    <div class="page-container">

        <nav class="sidebar">
            <div class="sidebar-search">
                <i class="fas fa-magnifying-glass"></i>
                <input type="text" placeholder="Pesquisar">
            </div>

            <ul class="sidebar-nav">
                <li><a href="dashboard.html"><i class="fas fa-house"></i><span>Home</span></a></li>
                <li><a href="dashboard.html"><i class="fas fa-chart-pie"></i><span>Dashboard</span></a></li>
                <li class="active"><a href="gerarlote.html"><i
                            class="fas fa-dollar-sign"></i><span>Geração de lotes</span></a></li>
                <li><a href="trackinglotesremessas.html"><i
                            class="fas fa-clipboard-list"></i><span>Processos</span></a></li>
            </ul>
            <div class="sidebar-footer">
                <ul class="sidebar-nav">
                    <li><a href="#"><i class="fas fa-circle-question"></i><span>Ajuda</span></a></li>
                    <li>
                        <a href="configuracoes.html">
                            <i class="fas fa-gear"></i>
                            <span>Configurações</span>
                        </a>
                    </li>
                </ul>
                <div class="user-profile">
                    <img src="img/adriana.png" alt="Foto de Adriana Nunes" class="avatar">
                    <div class="user-info">
                        <span class="user-name">Adriana Nunes</span>
                        <span class="user-email">financeiro@poyer.com</span>
                    </div>
                    <a href="loginpage.html" style="color: inherit; margin-left: auto;">
                        <i class="fas fa-arrow-right-from-bracket"></i>
                    </a>
                </div>
            </div>
        </nav>

        <main class="main-content">

            <header class="main-header">
                <h1>Geração de Lote de Faturamento</h1>
            </header>

            <section class="page-controls">
                <div class="filters">
                    <span class="filter-tag">
                        Último mês <i class="fas fa-times"></i>
                    </span>
                    <span class="filter-tag">
                        Unimed <i class="fas fa-times"></i>
                    </span>
                    <button class="btn btn-filter">
                        <i class="fas fa-filter"></i>
                        <span>Filtros</span>
                    </button>
                </div>

                <div class="page-actions">
                    <div class="total-selected">
                        Total Selecionado [3]: <span>R$490,00</span>
                    </div>
                    <button class="btn btn-xml">Gerar XML</button>
                    <div class="action-search">
                        <i class="fas fa-magnifying-glass"></i>
                        <input type="text" placeholder="Pesquisar">
                    </div>
                </div>
            </section>

            <section class="billing-list-container">

                <div class="list-item list-header">
                    <div class="col-check">
                        <i class="fa-regular fa-square"></i>
                    </div>
                    <div class="col-convenio">
                        Convênio <i class="fas fa-sort-down"></i>
                    </div>
                    <div>Paciente</div>
                    <div>Procedimento</div>
                    <div>Data</div>
                    <div>Valor</div>
                </div>



            </section>

        </main>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const listContainer = document.querySelector('.billing-list-container');
            const totalSelectedEl = document.querySelector('.total-selected');
            const btnXml = document.querySelector('.btn-xml');
            let allLots = [];
            let selectedIds = new Set();

            const fetchLots = async () => {
                try {
                    const response = await fetch('http://localhost:3000/billing-lots');
                    const lots = await response.json();
                    allLots = lots.filter(lot => lot.status === 'PENDENTE');
                    renderLots();
                } catch (error) {
                    console.error('Erro ao buscar lotes:', error);
                    alert('Erro ao carregar lotes.');
                }
            };

            const renderLots = () => {
                const header = listContainer.querySelector('.list-header');
                listContainer.innerHTML = '';
                listContainer.appendChild(header);

                if (allLots.length === 0) {
                    const emptyMsg = document.createElement('div');
                    emptyMsg.style.padding = '20px';
                    emptyMsg.style.textAlign = 'center';
                    emptyMsg.style.color = 'var(--text-secondary)';
                    emptyMsg.textContent = 'Nenhum lote pendente encontrado.';
                    listContainer.appendChild(emptyMsg);
                    return;
                }

                allLots.forEach(lot => {
                    const row = document.createElement('div');
                    row.className = 'list-item list-row';

                    const isSelected = selectedIds.has(lot.id);
                    const checkIconClass = isSelected ? 'fas fa-square-check' : 'fa-regular fa-square';
                    const checkColor = isSelected ? 'var(--color-green)' : 'var(--text-secondary)';

                    const formatDate = (dateStr) => {
                        if (!dateStr) return '';
                        const [year, month, day] = dateStr.split('-');
                        return `${day}/${month}/${year}`;
                    };

                    const formatCurrency = (val) => {
                        return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(val);
                    };

                    let imgName = 'unimed.png';
                    let insuranceName = 'Unimed';
                    if (lot.healthInsurance === 'BRADESCO') {
                        imgName = 'bradesco.png';
                        insuranceName = 'Bradesco';
                    } else if (lot.healthInsurance === 'SULAMERICA') {
                        imgName = 'sulamerica.png';
                        insuranceName = 'SulAmérica';
                    }

                    row.innerHTML = `
                        <div class="col-check" data-id="${lot.id}">
                            <i class="${checkIconClass}" style="color: ${checkColor}"></i>
                        </div>
                        <div class="col-convenio">
                            <img src="img/${imgName}" alt="${insuranceName}" class="logo-op" onerror="this.style.display='none'">
                            <span>${insuranceName}</span>
                        </div>
                        <div>${lot.patient ? lot.patient.fullName : 'Paciente não identificado'}</div>
                        <div>${lot.procedure}</div>
                        <div>${formatDate(lot.date)}</div>
                        <div class="col-valor">${formatCurrency(lot.value)}</div>
                    `;

                    row.querySelector('.col-check').addEventListener('click', () => toggleSelection(lot.id));

                    listContainer.appendChild(row);
                });

                updateTotals();
            };

            const toggleSelection = (id) => {
                if (selectedIds.has(id)) {
                    selectedIds.delete(id);
                } else {
                    selectedIds.add(id);
                }
                renderLots();
            };

            const updateTotals = () => {
                const selectedLots = allLots.filter(lot => selectedIds.has(lot.id));
                const totalValue = selectedLots.reduce((sum, lot) => sum + Number(lot.value), 0);

                const formattedTotal = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(totalValue);

                totalSelectedEl.innerHTML = `Total Selecionado [${selectedLots.length}]: <span>${formattedTotal}</span>`;
            };

            const headerCheck = listContainer.querySelector('.list-header .col-check i');
            headerCheck.parentElement.addEventListener('click', () => {
                if (selectedIds.size === allLots.length && allLots.length > 0) {
                    selectedIds.clear();
                    headerCheck.className = 'fa-regular fa-square';
                    headerCheck.style.color = 'var(--text-secondary)';
                } else {
                    allLots.forEach(lot => selectedIds.add(lot.id));
                    headerCheck.className = 'fas fa-square-check';
                    headerCheck.style.color = 'var(--color-green)';
                }
                renderLots();
            });

            btnXml.addEventListener('click', async () => {
                if (selectedIds.size === 0) {
                    alert('Selecione pelo menos um lote para gerar o XML.');
                    return;
                }

                try {
                    const response = await fetch('http://localhost:3000/billing-lots/process', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ ids: Array.from(selectedIds) })
                    });

                    if (response.ok) {
                        alert('Lotes processados com sucesso! XML gerado.');
                        selectedIds.clear();
                        selectedIds.clear();
                        fetchLots();
                    } else {
                        alert('Erro ao processar lotes.');
                    }
                } catch (error) {
                    console.error('Erro:', error);
                    alert('Erro de conexão com o servidor.');
                }
            });

            fetchLots();
        });
    </script>
</body>

</html>